# Copilot Instructions

## Commands

```bash
npm run dev          # Start Next.js dev server (webpack, not turbopack)
npm run test         # Full check: typecheck + typecheck-sw + knip + lint
npm run typecheck    # TypeScript check for the main app
npm run typecheck-sw # TypeScript check for the service worker (separate tsconfig)
npm run lint         # ESLint
npm run knip         # Unused exports/files check
npm run build:sw     # Build service worker separately with esbuild
npm run build        # build:sw + next build
npx convex dev       # Start Convex backend (required alongside next dev)
```

There are no unit tests — `npm test` is purely static analysis.

## Architecture

This is a household task scheduling PWA with a Next.js frontend and Convex backend.

**Frontend** (`src/app/`, `src/components/`): Next.js App Router, single page app. UI state (selected task, edit mode) lives in the URL via `nuqs`. Authentication state is handled by `convex/react`'s `<Authenticated>`, `<Unauthenticated>`, and `<AuthLoading>` components.

**Backend** (`src/convex/`): Convex functions (queries, mutations, internal actions). Auth uses `@convex-dev/auth`. Cron job runs hourly to send push notifications via `web-push` (VAPID). The `_generated/` subfolder is auto-generated by Convex — never edit it manually.

**Shared logic** (`src/shared/`): Pure TypeScript modules shared between frontend and Convex backend. Contains task status calculation (`taskStatus`), task comparison/sorting, time unit conversions, and type definitions. Both sides import from here.

**Service worker** (`src/service-worker/`): Compiled independently by esbuild into `public/sw.js`. Has its own `tsconfig.json` and is excluded from the main tsconfig. Handles push notification display and click routing using a `ConvexClient`.

## Key Conventions

**CSS**: All styles use [vanilla-extract](https://vanilla-extract.style/) (`.css.ts` files). No plain CSS, CSS modules, or Tailwind. Import styles as a namespace: `import * as styles from './foo.css'`. Tokens/colors are defined in `src/app/themes.css.ts` via `createGlobalTheme` and should be used instead of raw color values.

**Path alias**: `@/*` resolves to `src/*`. Use it for all cross-directory imports (e.g., `@/convex/_generated/api`, `@/shared/tasks`, `@/components/Button`).

**Language**: UI-facing strings are in French.

**Task status model**: Tasks have a `period` and `tolerance` in configurable time units. Status (`veryLate`, `late`, `dueNow`, `dueSoon`, `waiting`, `archived`) is computed in `src/shared/tasks.ts`. `toBeDoneTime` is the next due timestamp — either fixed-schedule or computed from last accomplishment.

**Convex data access**: Queries filter by `visibleTo` (user must be in the array). `parseTask()` in `src/convex/tasks.ts` converts a raw `Doc<"tasks">` to the richer `Task` type by resolving user IDs to user objects.

**Environment variables**: `CONVEX_DEPLOYMENT` and `NEXT_PUBLIC_CONVEX_URL` are required. Push notifications additionally require `NEXT_PUBLIC_VAPID_PUBLIC_KEY`, `VAPID_PRIVATE_KEY`, and `CONVEX_SITE_URL`.
